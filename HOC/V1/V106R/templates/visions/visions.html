{% extends 'base/base.html' %}
{% load to_jalali %}
{% load static %}
{% block title %}Vision ها{% endblock %}
{% block Link %}
<link rel="stylesheet" href="{% static 'visions/css/style.css' %}?version={{version}}" type="text/css">
{% endblock %}
{% block content %}
<div class="page-wrapper">
    <div class="page-header">
        <h1 class="page-title">
            <svg width="20" height="20" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.23 6.2463C13.3958 6.45302 13.4876 6.72159 13.4876 7.00006C13.4876 7.27853 13.3958 7.5471 13.23 7.75382C12.18 9.02509 9.78997 11.5001 6.99997 11.5001C4.20997 11.5001 1.81997 9.02509 0.769968 7.75382C0.604128 7.5471 0.512329 7.27853 0.512329 7.00006C0.512329 6.72159 0.604128 6.45302 0.769968 6.2463C1.81997 4.97503 4.20997 2.5 6.99997 2.5C9.78997 2.5 12.18 4.97503 13.23 6.2463Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 9C8.10457 9 9 8.10457 9 7C9 5.89543 8.10457 5 7 5C5.89543 5 5 5.89543 5 7C5 8.10457 5.89543 9 7 9Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Vision ها
        </h1>
        <a href="{% url 'add_vision' %}" class="btn btn-primary">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 0.5V13.5" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M0.5 6.95996H13.5" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
                
            افزودن Vision
        </a>
    </div>

    {% if visions %}
    <div class="stats-grid">
        {% for vision in visions %}
        {% if not vision.Is_Deleted %}
        <div class="stat-card">
            <div class="stat-icon primary">
                <svg width="20" height="20" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.23 6.2463C13.3958 6.45302 13.4876 6.72159 13.4876 7.00006C13.4876 7.27853 13.3958 7.5471 13.23 7.75382C12.18 9.02509 9.78997 11.5001 6.99997 11.5001C4.20997 11.5001 1.81997 9.02509 0.769968 7.75382C0.604128 7.5471 0.512329 7.27853 0.512329 7.00006C0.512329 6.72159 0.604128 6.45302 0.769968 6.2463C1.81997 4.97503 4.20997 2.5 6.99997 2.5C9.78997 2.5 12.18 4.97503 13.23 6.2463Z" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 9C8.10457 9 9 8.10457 9 7C9 5.89543 8.10457 5 7 5C5.89543 5 5 5.89543 5 7C5 8.10457 5.89543 9 7 9Z" stroke="white" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ vision.name }}</div>
                <div class="stat-label">{{ vision.warehouse.name }}</div>
            </div>
            <div class="action-btns">
                <a href="{% url 'view_vision' vision.id %}" class="btn btn-sm btn-info" title="مشاهده">
                    <svg width="16" height="16" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.23 6.2463C13.3958 6.45302 13.4876 6.72159 13.4876 7.00006C13.4876 7.27853 13.3958 7.5471 13.23 7.75382C12.18 9.02509 9.78997 11.5001 6.99997 11.5001C4.20997 11.5001 1.81997 9.02509 0.769968 7.75382C0.604128 7.5471 0.512329 7.27853 0.512329 7.00006C0.512329 6.72159 0.604128 6.45302 0.769968 6.2463C1.81997 4.97503 4.20997 2.5 6.99997 2.5C9.78997 2.5 12.18 4.97503 13.23 6.2463Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 9C8.10457 9 9 8.10457 9 7C9 5.89543 8.10457 5 7 5C5.89543 5 5 5.89543 5 7C5 8.10457 5.89543 9 7 9Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
                <a href="{% url 'edit_vision' vision.id %}" class="btn btn-sm btn-warning" title="ویرایش">
                    <svg width="16" height="16" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_1222_41922)">
                        <path d="M6.92572 13.2018L3.92572 13.4618L4.18572 10.4618L10.4257 4.26181C10.5189 4.16657 10.6301 4.09089 10.7529 4.03922C10.8756 3.98755 11.0075 3.96094 11.1407 3.96094C11.2739 3.96094 11.4058 3.98755 11.5286 4.03922C11.6514 4.09089 11.7626 4.16657 11.8557 4.26181L13.1257 5.54181C13.2194 5.63478 13.2938 5.74538 13.3446 5.86724C13.3954 5.9891 13.4215 6.1198 13.4215 6.25181C13.4215 6.38382 13.3954 6.51453 13.3446 6.63639C13.2938 6.75825 13.2194 6.86885 13.1257 6.96181L6.92572 13.2018Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M0.841689 3.97204C0.490759 3.91098 0.490759 3.40721 0.841688 3.34616C2.11305 3.12497 3.12423 2.15661 3.40019 0.896007L3.42134 0.799378C3.49726 0.452545 3.99111 0.450386 4.07006 0.796542L4.09574 0.909152C4.38191 2.16381 5.39337 3.12399 6.6612 3.34456C7.01392 3.40592 7.01392 3.91227 6.6612 3.97363C5.39337 4.1942 4.38191 5.15438 4.09574 6.40904L4.07006 6.52165C3.99111 6.86781 3.49726 6.86565 3.42134 6.51881L3.40019 6.42219C3.12423 5.16158 2.11305 4.19322 0.841689 3.97204Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_1222_41922">
                        <rect width="14" height="14" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                </a>
                <a href="{% url 'delete_vision' vision.id %}" class="btn btn-sm btn-danger" title="حذف">
                    <svg width="16" height="16" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_1222_37750)">
                        <path d="M1 3.5H13" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2.5 3.5H11.5V12.5C11.5 12.7652 11.3946 13.0196 11.2071 13.2071C11.0196 13.3946 10.7652 13.5 10.5 13.5H3.5C3.23478 13.5 2.98043 13.3946 2.79289 13.2071C2.60536 13.0196 2.5 12.7652 2.5 12.5V3.5Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4.5 3.5V3C4.5 2.33696 4.76339 1.70107 5.23223 1.23223C5.70107 0.763392 6.33696 0.5 7 0.5C7.66304 0.5 8.29893 0.763392 8.76777 1.23223C9.23661 1.70107 9.5 2.33696 9.5 3V3.5" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5.5 6.50146V10.503" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8.5 6.50146V10.503" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_1222_37750">
                        <rect width="14" height="14" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                </a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i>i</i>
        <h3 class="empty-state-title">Vision ای یافت نشد</h3>
        <p class="empty-state-text">برای افزودن Vision جدید از دکمه بالا استفاده کنید</p>
    </div>
    {% endif %}
    <div class="divider"></div>
    <h3 class="section-title"><i>i</i> تشخیصات سازمان‌یافته</h3>
    
    <div class="filter-wrapper" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="?show_all=1{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}" 
           onclick="return toggleShowAll(event)" 
           class="btn btn-sm {% if not exclude_forklift %}btn-primary{% else %}btn-outline{% endif %}">همه</a>
        <a href="?{% if selected_types %}type={{ selected_types|join:',' }}{% endif %}" 
           onclick="return toggleExcludeForklift(event)" 
           class="btn btn-sm {% if exclude_forklift and not selected_types %}btn-primary{% else %}btn-outline{% endif %}">همه به غیر از forklift</a>
        <a href="#" onclick="return toggleType(event, '1')" 
           class="btn btn-sm {% if '1' in selected_types %}btn-primary{% else %}btn-outline{% endif %}">تخلیه</a>
        <a href="#" onclick="return toggleType(event, '2')" 
           class="btn btn-sm {% if '2' in selected_types %}btn-primary{% else %}btn-outline{% endif %}">بارگیری</a>
        <a href="#" onclick="return toggleType(event, '3')" 
           class="btn btn-sm {% if '3' in selected_types %}btn-primary{% else %}btn-outline{% endif %}">جابجایی</a>
        <a href="#" onclick="return toggleType(event, '4')" 
           class="btn btn-sm {% if '4' in selected_types %}btn-primary{% else %}btn-outline{% endif %}">ورود</a>
        <a href="#" onclick="return toggleType(event, '5')" 
           class="btn btn-sm {% if '5' in selected_types %}btn-primary{% else %}btn-outline{% endif %}">خروج</a>
    </div>
    <script>
    function buildUrl(params) {
        let url = '?';
        let parts = [];
        if (params.type) parts.push('type=' + params.type);
        if (params.show_all) parts.push('show_all=1');
        if (params.organizing_page) parts.push('organizing_page=' + params.organizing_page);
        if (params.vision_page) parts.push('vision_page=' + params.vision_page);
        return url + parts.join('&');
    }
    function toggleType(event, typeId) {
        event.preventDefault();
        const params = new URLSearchParams(window.location.search);
        let types = params.get('type') ? params.get('type').split(',').filter(t => t) : [];
        if (types.includes(typeId)) {
            types = types.filter(t => t !== typeId);
        } else {
            types.push(typeId);
        }
        window.location.href = buildUrl({
            type: types.join(','),
            show_all: params.get('show_all'),
            vision_page: params.get('vision_page')
        });
        return false;
    }
    function toggleShowAll(event) {
        event.preventDefault();
        const params = new URLSearchParams(window.location.search);
        window.location.href = buildUrl({
            type: params.get('type'),
            show_all: '1',
            vision_page: params.get('vision_page')
        });
        return false;
    }
    function toggleExcludeForklift(event) {
        event.preventDefault();
        const params = new URLSearchParams(window.location.search);
        window.location.href = buildUrl({
            type: params.get('type'),
            vision_page: params.get('vision_page')
        });
        return false;
    }
    </script>
    
    {% if organizing_vision_detections %}
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>نام</th>
                    <th>تعداد تشخیص</th>
                    <th>مکان</th>
                    <th>مقصد</th>
                    <th>نوع</th>
                    <th>بازه زمانی</th>
                    <th>زمان</th>
                    <th>شماره پلاک</th>
                </tr>
            </thead>
            <tbody>
                {% for detection in organizing_vision_detections %}
                <tr>
                    <td>{{ detection.class_name }}</td>
                    <td>{{ detection.count }}</td>
                    <td>{{ detection.location.name }}</td>
                    <td>{{ detection.destenation.name }}</td>
                    <td>{{ detection.get_Type_display }}</td>
                    <td>{{ detection.time_text }}</td>
                    <td>{{ detection.time }}</td>
                    <td>{{ detection.shipment.Truck.License_plate_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if organizing_vision_detections.paginator.num_pages > 1 %}
    <div class="pagination">
        <div class="pagination-pages">
            {% if organizing_vision_detections.has_previous %}
            <a href="?organizing_page=1{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if vision_data.number != 1 %}&vision_page={{ vision_data.number }}{% endif %}" class="pagination-link" title="اولین">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
            </a>
            <a href="?organizing_page={{ organizing_vision_detections.previous_page_number }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if vision_data.number != 1 %}&vision_page={{ vision_data.number }}{% endif %}" class="pagination-link" title="قبلی">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </a>
            {% endif %}
            
            <span class="pagination-info">صفحه {{ organizing_vision_detections.number }} از {{ organizing_vision_detections.paginator.num_pages }}</span>
            
            {% if organizing_vision_detections.has_next %}
            <a href="?organizing_page={{ organizing_vision_detections.next_page_number }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if vision_data.number != 1 %}&vision_page={{ vision_data.number }}{% endif %}" class="pagination-link" title="بعدی">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </a>
            <a href="?organizing_page={{ organizing_vision_detections.paginator.num_pages }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if vision_data.number != 1 %}&vision_page={{ vision_data.number }}{% endif %}" class="pagination-link" title="آخرین">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></svg>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if vision_data %}
    <div class="divider"></div>
    <h3 class="section-title"><i>i</i> داده‌های Vision</h3>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Vision</th>
                    <th>نام</th>
                    <th>مکان</th>
                    <th>تعداد</th>
                    <th>ورود</th>
                    <th>خروج</th>
                    <th>زمان تشخیص</th>
                    <th>زمان ثبت</th>
                </tr>
            </thead>
            <tbody>
                {% for data in vision_data %}
                <tr>
                    <td>{{ data.vision.name }}</td>
                    <td>{{ data.name }}</td>
                    <td>{{ data.vision.warehouse.name }}</td>
                    <td>{{ data.count }}</td>
                    <td>{{ data.enter }}</td>
                    <td>{{ data.exit }}</td>
                    <td>{% to_jalali data.detections_time %}</td>
                    <td>{% to_jalali data.CreationDateTime %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if vision_data.paginator.num_pages > 1 %}
    <div class="pagination">
        <div class="pagination-pages">
            {% if vision_data.has_previous %}
            <a href="?vision_page=1{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if organizing_vision_detections.number != 1 %}&organizing_page={{ organizing_vision_detections.number }}{% endif %}" class="pagination-link" title="اولین">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
            </a>
            <a href="?vision_page={{ vision_data.previous_page_number }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if organizing_vision_detections.number != 1 %}&organizing_page={{ organizing_vision_detections.number }}{% endif %}" class="pagination-link" title="قبلی">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </a>
            {% endif %}
            
            <span class="pagination-info">صفحه {{ vision_data.number }} از {{ vision_data.paginator.num_pages }}</span>
            
            {% if vision_data.has_next %}
            <a href="?vision_page={{ vision_data.next_page_number }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if organizing_vision_detections.number != 1 %}&organizing_page={{ organizing_vision_detections.number }}{% endif %}" class="pagination-link" title="بعدی">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </a>
            <a href="?vision_page={{ vision_data.paginator.num_pages }}{% if selected_types %}&type={{ selected_types|join:',' }}{% endif %}{% if not exclude_forklift %}&show_all=1{% endif %}{% if organizing_vision_detections.number != 1 %}&organizing_page={{ organizing_vision_detections.number }}{% endif %}" class="pagination-link" title="آخرین">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></svg>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
