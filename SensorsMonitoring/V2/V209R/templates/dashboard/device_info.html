{% extends "base/base.html" %}
{% load static %}
{% load to_jalali %}
{% block title %}Device Info - {{ device.name|default:"Unknown Device" }}{% endblock %}
{% block Link %}{% endblock %}
{% block content %}
<div class="container-fliud p-3 mt-5">
    <div class="stats-grid">
        <div class="stat-card device-stat">
            <div class="stat-card-background"></div>
            <div class="stat-icon">
                <svg width="28" height="28" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_1222_41186)">
                    <path d="M10 0.5H4C3.44772 0.5 3 0.947715 3 1.5V12.5C3 13.0523 3.44772 13.5 4 13.5H10C10.5523 13.5 11 13.0523 11 12.5V1.5C11 0.947715 10.5523 0.5 10 0.5Z" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 3.5H0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 7H0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 10.5H0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13.5 3.5H11" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13.5 7H11" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13.5 10.5H11" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6.5 10.5H8.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_1222_41186">
                    <rect width="14" height="14" fill="white"/>
                    </clipPath>
                    </defs>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-info">
                    <h3 class="stat-title">نام دستگاه</h3>
                    <p class="stat-value">{{ device.name|default:"ناشناس" }}</p>
                    <p id="device_id" class="stat-value d-none">{{ device.device_id|default:"ناشناس" }}</p>
                </div>
                <div class="stat-decoration">
                    <div class="decoration-circle"></div>
                </div>
            </div>
        </div>

        <div class="stat-card sensor-stat">
            <div class="stat-card-background"></div>
            <div class="stat-icon">
                <svg width="28" height="28" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_1222_41038)">
                    <path d="M10 3H4C3.44772 3 3 3.44772 3 4V10C3 10.5523 3.44772 11 4 11H10C10.5523 11 11 10.5523 11 10V4C11 3.44772 10.5523 3 10 3Z" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 3V0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 3V0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 9H0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 5H0.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 11V13.5" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 11V13.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M11 5H13.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M11 9H13.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8.5 7.5H6.5" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_1222_41038">
                    <rect width="14" height="14" fill="white"/>
                    </clipPath>
                    </defs>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-info">
                    <h3 class="stat-title">نوع سنسور</h3>
                    <p class="stat-value">{{ sensor.sensor_type }}</p>
                    <p id="sensor_type" class="stat-value d-none">{{ sensor.sensor_type }}</p>
                </div>
                <div class="stat-decoration">
                    <div class="decoration-circle"></div>
                </div>
            </div>
        </div>

        <div class="stat-card logs-stat">
            <div class="stat-card-background"></div>
            <div class="stat-icon">
                <svg width="28" height="28" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_1222_41102)">
                    <path d="M7 5.5C10.5899 5.5 13.5 4.38071 13.5 3C13.5 1.61929 10.5899 0.5 7 0.5C3.41015 0.5 0.5 1.61929 0.5 3C0.5 4.38071 3.41015 5.5 7 5.5Z" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M0.5 3V11C0.5 12.38 3.41 13.5 7 13.5C10.59 13.5 13.5 12.38 13.5 11V3" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M13.5 7C13.5 8.38 10.59 9.5 7 9.5C3.41 9.5 0.5 8.38 0.5 7" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_1222_41102" >
                    <rect width="14" height="14"  fill="white"/>
                    </clipPath>
                    </defs>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-info">
                    <h3 class="stat-title">تعداد کل داده‌ها</h3>
                    <p class="stat-value">{{ all_logs|floatformat:0 }}</p>
                </div>
                <div class="stat-decoration">
                    <div class="decoration-circle"></div>
                </div>
            </div>
        </div>

        {% if device.location %}
        <div class="stat-card location-stat">
            <div class="stat-card-background"></div>
            <div class="stat-icon">
                <svg width="28" height="28" viewBox="0 0 10 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.5 5C9.5 8 5 11.5 5 11.5C5 11.5 0.5 8 0.5 5C0.5 2.549 2.549 0.5 5 0.5C7.451 0.5 9.5 2.549 9.5 5Z" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 6.5C5.82843 6.5 6.5 5.82843 6.5 5C6.5 4.17157 5.82843 3.5 5 3.5C4.17157 3.5 3.5 4.17157 3.5 5C3.5 5.82843 4.17157 6.5 5 6.5Z" stroke="CurrentColor" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-info">
                    <h3 class="stat-title">مکان</h3>
                    <p class="stat-value">{{ device.location }}</p>
                </div>
                <div class="stat-decoration">
                    <div class="decoration-circle"></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="chart-container-wrapper">
        <div class="chart-filter" style="text-align: center;">
            <a  class="{% if not 'daily' in request.GET and not 'week' in request.GET and not 'month' in request.GET %}active{% endif %}" onclick="Progress()">1 ساعت اخیر</a>
            <a  class="daily {% if 'daily' in request.GET %}active{% endif %}" onclick="Progress()">24 ساعت اخیر</a>
            <a  class="week {% if 'week' in request.GET %}active{% endif %}" onclick="Progress()">7 روز اخیر</a>
            <a  class="month {% if 'month' in request.GET %}active{% endif %}" onclick="Progress()">30 روز اخیر</a>
        </div>
        <div class="d-flex align-items-center">
            <div class="btn export_choices align-items-center date_range_filter" style="background-image: linear-gradient(90deg, #99e3d5, transparent);">
                <div class="filter_item d-flex align-items-center">
                    <label for="export_choices" class="mb-0 ml-2">بازه زمانی</label>
                    <input type="text" name="date_range_start" id="date_range_start" value="" placeholder="تاریخ شروع">
                </div>
                <div class="filter_item d-flex align-items-center">
                    <input type="text" name="date_range_end" id="date_range_end" value="" placeholder="مثال: 1402-01-01">
                </div>
                <div class="filter_item d-flex align-items-center ml-2">
                    <label for="time_choices" class="mb-0 ml-2">نمایش ساعتی</label>
                    <input type="radio" name="time_choices" id="time_choices" value="1" checked>
                </div>
                <div class="filter_item d-flex align-items-center">
                    <label for="time_choices1" class="mb-0 ml-2">نمایش دقیقه ای</label>
                    <input type="radio" name="time_choices" id="time_choices1" value="2">
                </div>
            </div>
            <div class="export-data apply-date-range-filter mr-2">
                <button class="btn" style="background: rgba(0, 185, 150, 0.4);" onclick="build_chart()">
                    اعمال فیلتر
                </button>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <div class="btn export_choices align-items-center" style="background-image: linear-gradient(90deg, #99e3d5, transparent);">
                <div class="filter_item d-flex align-items-center ml-2">
                    <label for="export_choices" class="mb-0 ml-2">همان چیزی که تو گراف میبینم</label>
                    <input type="radio" name="export_choices" id="export_choices" value="1" checked>
                </div>
                <div class="filter_item d-flex align-items-center">
                    <label for="export_choices1" class="mb-0 ml-2">تمامی دیتا های این بازه</label>
                    <input type="radio" name="export_choices" id="export_choices1" value="2">
                </div>
            </div>
            <span class="text-secondary text-secondary">
                ---
            </span>
            <div class="export-data">
                <button class="btn" style="background: rgba(0, 185, 150, 0.4);" type="button" onclick="exportData({{ sensor.id }})">
                    خروجی Excel
                    <svg width="16" height="20" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 1.00087C8.90451 1 8.79728 1 8.67471 1H4.2002C3.08009 1 2.51962 1 2.0918 1.21799C1.71547 1.40973 1.40973 1.71547 1.21799 2.0918C1 2.51962 1 3.08009 1 4.2002V15.8002C1 16.9203 1 17.4801 1.21799 17.9079C1.40973 18.2842 1.71547 18.5905 2.0918 18.7822C2.51921 19 3.079 19 4.19694 19L11.8031 19C12.921 19 13.48 19 13.9074 18.7822C14.2837 18.5905 14.5905 18.2842 14.7822 17.9079C15 17.4805 15 16.9215 15 15.8036V7.32568C15 7.20296 15 7.09561 14.9991 7M9 1.00087C9.28564 1.00347 9.46634 1.01385 9.63884 1.05526C9.84291 1.10425 10.0379 1.18526 10.2168 1.29492C10.4186 1.41857 10.5918 1.59182 10.9375 1.9375L14.063 5.06298C14.4089 5.40889 14.5809 5.58136 14.7046 5.78319C14.8142 5.96214 14.8953 6.15726 14.9443 6.36133C14.9857 6.53376 14.9963 6.71451 14.9991 7M9 1.00087V3.8C9 4.9201 9 5.47977 9.21799 5.90759C9.40973 6.28392 9.71547 6.59048 10.0918 6.78223C10.5192 7 11.079 7 12.1969 7H14.9991M14.9991 7H15.0002" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    
                </button>
            </div>
        </div>
    </div>
    <div class="chart-container" id="charts_container">

    </div>
    {% for x in chart_data %}
    <div id="chart_{{ forloop.counter }}" class="chart">
    </div>
    {% endfor %}

    {% if page_obj %}
    <div class="data-section">
        <div class="section-header">
            <h2 class="section-title">تاریخچه داده‌ها</h2>
            <div class="data-count">{{ page_obj|length }} مورد از {{ all_logs }} داده</div>
        </div>

        <div class="data-table-container">
            <table class="data-table" id="LogsData">
                <thead>
                    <tr>
                        <th>زمان</th>
                        <th>داده</th>
                        <th>Device ID</th>
                        <th>IP Address</th>
                        <th>وضعیت</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in page_obj %}
                    <tr class="data-row">
                        <td class="time-cell">
                            <div class="time-content">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                {% to_jalali item.CreationDateTime %}
                            </div>
                        </td>
                        <td class="data-cell">
                            <span class="data-value-badge" data-value="{{ item.data }}">{{ item.data }}</span>
                        </td>
                        <td class="device-id-cell">{{ item.sensor.device.device_id }}</td>
                        <td class="ip-cell">{{ item.sensor.device.ip_address }}</td>
                        <td class="status-cell">
                            <span class="status-badge {% if item.sensor.device.Is_Known %}status-known{% else %}status-unknown{% endif %}">
                                {% if item.sensor.device.Is_Known %}شناخته شده{% else %}ناشناس{% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile List View (visible only on max-width: 768px) -->
        <div class="mobile-data-list">
            {% for item in page_obj %}
            <div class="mobile-data-item">
                <div class="mobile-item-header">
                    <div class="mobile-item-time">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>{% to_jalali item.CreationDateTime %}</span>
                    </div>
                    <span class="mobile-status-badge {% if item.sensor.device.Is_Known %}status-known{% else %}status-unknown{% endif %}">
                        {% if item.sensor.device.Is_Known %}شناخته شده{% else %}ناشناس{% endif %}
                    </span>
                </div>
                <div class="mobile-item-content">
                    <div class="mobile-item-row">
                        <span class="mobile-label">داده:</span>
                        <span class="mobile-data-value-trigger" data-value="{{ item.data }}" data-time="{% to_jalali item.CreationDateTime %}" data-device-id="{{ item.sensor.device.device_id }}" data-ip="{{ item.sensor.device.ip_address }}">
                            {{ item.data }}
                        </span>
                    </div>
                    <div class="mobile-item-row">
                        <span class="mobile-label">Device ID:</span>
                        <span class="mobile-value">{{ item.sensor.device.device_id }}</span>
                    </div>
                    <div class="mobile-item-row">
                        <span class="mobile-label">IP Address:</span>
                        <span class="mobile-value">{{ item.sensor.device.ip_address }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-data-state">
        <div class="empty-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="1.5"/>
                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="1.5"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="1.5"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="1.5"/>
            </svg>
        </div>
        <h3 class="empty-title">هیچ داده‌ای یافت نشد</h3>
        <p class="empty-message">داده‌ای تا الان دریافت نشده است. پس از دریافت داده‌ها، آن‌ها در اینجا نمایش داده خواهند شد.</p>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination-wrapper">
            <a onclick="Progress();window.location = `?page=1`;Progress()" class="pagination-btn pagination-first {% if page_obj.number == 1 %}disabled{% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 17L18 12L13 7M6 17L11 12L6 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                اولین
            </a>
            
            {% if page_obj.has_previous %}
            <a onclick="Progress();window.location = `?page={{ page_obj.previous_page_number }}`;Progress()" class="pagination-btn pagination-prev">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                قبلی
            </a>
            {% endif %}
            
            <div class="pagination-info">
                <span class="current-page">{{ page_obj.number }}</span>
                <span class="page-separator">از</span>
                <span class="total-pages">{{ page_obj.paginator.num_pages }}</span>
            </div>
            
            {% if page_obj.has_next %}
            <a onclick="Progress();window.location = `?page={{ page_obj.next_page_number }}`;Progress()" class="pagination-btn pagination-next">
                بعدی
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
            {% endif %}
            
            <a onclick="Progress();window.location = `?page={{ page_obj.paginator.num_pages }}`;Progress()" class="pagination-btn pagination-last {% if page_obj.number == page_obj.paginator.num_pages %}disabled{% endif %}">
                آخرین
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 17L6 12L11 7M18 17L13 12L18 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="calendar-modal" style="display: none;">
    <div class="calendar-modal-content">
        <div class="calendar-modal-header">
            <h4>انتخاب تاریخ</h4>
            <span class="calendar-modal-close">&times;</span>
        </div>
        <div class="calendar-modal-body">
            {% include "AM_Calendar/calendar.html" %}
        </div>
    </div>
</div>

<!-- Data Value Modal (Mobile Only) -->
<div id="dataValueModal" class="data-value-modal" style="display: none;">
    <div class="data-value-modal-overlay"></div>
    <div class="data-value-modal-content">
        <div class="data-value-modal-header">
            <h4>جزئیات داده</h4>
            <button class="data-value-modal-close" type="button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="data-value-modal-body">
            <div class="modal-data-item">
                <span class="modal-data-label">مقدار:</span>
                <span class="modal-data-value" id="modalDataValue"></span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">زمان:</span>
                <span class="modal-data-value" id="modalDataTime"></span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Device ID:</span>
                <span class="modal-data-value" id="modalDataDeviceId"></span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">IP Address:</span>
                <span class="modal-data-value" id="modalDataIp"></span>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block footer %}{% endblock %}
{% block Script %}
<script>
    let chart_filter = document.querySelectorAll('.chart-filter a');
    let charts_container = document.querySelector('#charts_container');
    function applyValueFilter(min_value,max_value,type) {
        console.log("min_value",min_value,max_value,type);
        data = {
            min_value: min_value,
            max_value: max_value,
            type: type,
        }
        console.log("data",data);
        build_chart();
    }
    function resetValueFilter(obj) {
        obj.querySelector(`div[id^="min-value-"]`).value = '';
        obj.querySelector(`div[id^="max-value-"]`).value = '';
    }
    function build_chart() {
        let date_range_start = document.querySelector('input[name="date_range_start"]').value;
        let date_range_end = document.querySelector('input[name="date_range_end"]').value;
        let time_choices = document.querySelector('input[name="time_choices"]:checked').value;
        console.log("time_choices",time_choices);
        if(time_choices == 1){
            time_choices = 'hourly';
        } else {
            time_choices = 'minute';
        }
        if(date_range_start && date_range_end){
            document.querySelector('.chart-filter').classList.add('disabled');
        } else {
            document.querySelector('.chart-filter').classList.remove('disabled');
        }
        let filter_data = [];
        let chart_value_filter = document.querySelectorAll('.chart-value-filter');
        chart_value_filter.forEach(item=>{
            filter_data.push({
                range: item.dataset.range,
                min_value: item.querySelector('input[id^="min-value-"]').value,
                max_value: item.querySelector('input[id^="max-value-"]').value,
                type: item.dataset.type,
            })
        });
        console.log("filter_data",filter_data);
        charts_container.innerHTML = '';
        chart_filter.forEach(item=>{
            let chart_container = document.createElement('div');
            chart_container.classList.add(item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly');
            charts_container.appendChild(chart_container);
            chart_container.classList.add('on_loading');

            item.addEventListener('click',()=>{
                Progress();
                chart_filter.forEach(item=>{
                    item.classList.remove('active');
                    document.querySelector(`#charts_container ${item.classList.contains("week") ? '.week' : item.classList.contains("month") ? '.month' : item.classList.contains("daily") ? '.daily' : '.hourly'}`).classList.remove('active');
                });
                item.classList.add('active');
                document.querySelector(`#charts_container ${item.classList.contains("week") ? '.week' : item.classList.contains("month") ? '.month' : item.classList.contains("daily") ? '.daily' : '.hourly'}`).classList.add('active');
                Progress(false);
            });
            fetch(`/dashboard/chart_info_json/{{ page_obj.0.sensor.id }}?${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    date_range_start: date_range_start,
                    date_range_end: date_range_end,
                    time_choices: time_choices,
                    filter_data: filter_data,
                    week: item.classList.contains("week"),
                    month: item.classList.contains("month"),
                    daily: item.classList.contains("daily"),
                })
            })
            .then(response => response.json())
            .then(data => {
                chart_container.classList.remove('on_loading');
                if(data.length < 1){
                    console.log("هیچ داده‌ای یافت نشد");
                    chart_container.insertAdjacentHTML('beforeend',`
                    <div class="alert alert-warning text-center">
                        هیچ داده‌ای یافت نشد
                    </div>
                    `);
                } else {
                }
                console.log("target_filter_data",data.target_filter_data,data);
                let index = 1;
                for(const x of data){
                    let chart_data = document.createElement('div');
                    chart_data.id = `chart_${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}_${x.type}`;
                    chart_container.appendChild(chart_data);
                    chart_data.insertAdjacentHTML('beforebegin',`
                    <div class="chart-container-wrapper chart-value-filter mb-3 mt-5" data-type="${x.type}" data-range="${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}">
                        <div class="filter-container">
                            <div class="filter-item">
                                <label for="min-value-chart-${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}-${x.type}">بازه مقادیر:</label>
                                <input type="number" id="min-value-chart-${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}-${x.type}" placeholder="حداقل" value="${x.target_filter_data ? x.target_filter_data.min_value : ''}" style="width: 120px; padding: 8px; border-radius: 5px; text-align: center;">
                            </div>
                            <div class="filter-item">
                                <input type="number" id="max-value-chart-${item.classList.contains("week") ? 'week' : item.classList.contains("month") ? 'month' : item.classList.contains("daily") ? 'daily' : 'hourly'}-${x.type}" placeholder="حداکثر" value="${x.target_filter_data ? x.target_filter_data.max_value : ''}" style="width: 120px; padding: 8px; border-radius: 5px; text-align: center;">
                            </div>
                            <button class="btn" style="font-size: 14px;" id="apply-filter" onclick="build_chart();">اعمال فیلتر</button>
                        </div>
                    </div>`);
                    let series_data = [{
                            name: x.type,
                            data: x.data,
                        }]
                    if(x.ai_data){
                        if(x.ai_data.length > 0){
                        series_data.push({
                                name: "AI",
                                data: x.ai_data,
                            })
                        }
                    }
                    var options = {
                        series: series_data,
                        chart: {
                            height: 500,
                            type: 'area',
                            zoom: {
                                enabled: false
                            },
                            toolbar: {
                                show: false,
                            },
                            fontFamily: 'Peyda',
                        },
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shade: 'light',              // or 'dark'
                                type: 'vertical',            // 'vertical' or 'horizontal'
                                shadeIntensity: 0.2,         // how strong the shading effect is
                                gradientToColors: undefined, // or specific colors ['#f8b26a']
                                inverseColors: false,
                                opacityFrom: 0.3,            // start opacity of area
                                opacityTo: 0.0,              // fade to transparent
                                stops: [0, 90, 100],         // where gradient stops happen
                            },
                        },
                        dataLabels: {
                            enabled: false,

                        },
                        markers: {
                            size: [0, 0],
                            colors: undefined,
                            strokeColors: '#ffffff',
                        },
                        stroke: {
                            curve: 'smooth',
                            width: 1,
                        },
                        colors: ['#00b996', '#ff9800'],

                        grid: {
                            xaxis: {
                                lines: {
                                    show: true
                                }
                            },
                            yaxis: {
                                lines: {
                                    show: true
                                }
                            },
                            row: {
                                colors: undefined,
                                opacity: 0.5
                            },
                            column: {
                                colors: undefined,
                                opacity: 0.5
                            },
                        },
                        xaxis: {

                            categories: x.timestamps,
                            min:1,
                            max:x.timestamps.length,
                            labels: {
                                style: {
                                    colors: ['#000'],
                                },
                                rotate: 0,
                            },
                            style: {
                                fontFamily: 'Peyda',
                            },
                        },
                        yaxis: {
                            labels: {
                            formatter: function (val) {
                                return val.toFixed(2);
                            },
                            style: {
                                colors: ['#000'],
                                fontFamily: 'Peyda',
                            },
                            offsetX: -25,
                            },
                        },
                        tooltip: {
                            shared: true,
                            intersect: false,
                            y: {
                                formatter: function (val) {
                                    if (typeof val === 'undefined' || val === null) return '';
                                    return val.toFixed(2);
                                }
                            },
                            style: {
                                fontSize: '14px',
                                fontFamily: 'Peyda',
                                color: '#000',
                                direction: 'rtl',
                            },
                            marker: {
                                show: true,
                            },
                            theme: 'light',
                        },
                        legend: {
                            fontFamily: 'Peyda',
                            fontSize: '15px',
                            horizontalAlign: 'center',
                            markers: {
                                width: 19,
                                height: 19,
                                offsetX: 6,
                                offsetY: 0
                            },
                            itemMargin: {
                                horizontal: 20,
                                vertical: 0,
                            },
                        },
                        title: {
                        text: x.type,
                        align: 'center'
                        },
                        // title: {
                        //     text: 'تولید ماه جاری',
                        //     align: 'center',
                        //     margin: 30,
                        //     offsetX: 0,
                        //     offsetY: 0,
                        //     floating: false,
                        //     style: {
                        //         fontSize: '15px',
                        //         fontWeight: 'bold',
                        //         fontFamily: 'Peyda',
                        //         color: 'var(--main)'
                        //     },
                        // },
                    };

                    new ApexCharts(chart_data, options).render();
                    chart_container.classList.remove('on_loading');
                    index++;
                }
                Progress(false);
            })
            .catch(error => {
                console.error("Error:", error);
                Progress(false);
            });
            chart_filter.forEach(item=>{
                item.classList.remove('active');
            });
            document.querySelector(".chart-filter > a").classList.add('active');
            document.querySelector("#charts_container > div").classList.add('active');
        });
    }

    build_chart();

    // Mobile Data Value Modal Handler
    const dataValueModal = document.getElementById('dataValueModal');
    const dataValueTriggers = document.querySelectorAll('.mobile-data-value-trigger');
    const dataValueModalClose = document.querySelector('.data-value-modal-close');
    const dataValueModalOverlay = document.querySelector('.data-value-modal-overlay');

    dataValueTriggers.forEach(trigger => {
        trigger.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            const time = this.getAttribute('data-time');
            const deviceId = this.getAttribute('data-device-id');
            const ip = this.getAttribute('data-ip');

            document.getElementById('modalDataValue').textContent = value;
            document.getElementById('modalDataTime').textContent = time;
            document.getElementById('modalDataDeviceId').textContent = deviceId;
            document.getElementById('modalDataIp').textContent = ip;

            dataValueModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });
    });

    function closeDataValueModal() {
        dataValueModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    if (dataValueModalClose) {
        dataValueModalClose.addEventListener('click', closeDataValueModal);
    }

    if (dataValueModalOverlay) {
        dataValueModalOverlay.addEventListener('click', closeDataValueModal);
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && dataValueModal.style.display === 'flex') {
            closeDataValueModal();
        }
    });
</script>
<script src="{% static 'dashboard/js/dashboard.js' %}?version={{version}}"></script>
{% endblock %}